# SchÃ©ma du flux audio en C++ (pour debug artefacts)

## Vue d'ensemble du pipeline

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WASAPI Capture (Thread sÃ©parÃ©)                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Desktop Audio (Loopback)                                   â”‚ â”‚
â”‚  â”‚ - Format natif (peut varier: 44.1kHz, 48kHz, etc.)        â”‚ â”‚
â”‚  â”‚ - Peut Ãªtre mono/stereo                                   â”‚ â”‚
â”‚  â”‚ - Format: PCM int16 ou float32                             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                 â”‚                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ AudioCapture::ProcessDesktopAudio()                        â”‚ â”‚
â”‚  â”‚ 1. ConvertToFloat32()                                     â”‚ â”‚
â”‚  â”‚    â†’ Convertit int16 â†’ float32 [-1.0, 1.0]                â”‚ â”‚
â”‚  â”‚ 2. ResampleToTarget()                                      â”‚ â”‚
â”‚  â”‚    â†’ 48kHz (si nÃ©cessaire)                                 â”‚ â”‚
â”‚  â”‚ 3. AdaptChannels()                                        â”‚ â”‚
â”‚  â”‚    â†’ StÃ©rÃ©o (si nÃ©cessaire)                               â”‚ â”‚
â”‚  â”‚ Output: float32, 48kHz, stÃ©rÃ©o                             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                 â”‚                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Microphone Audio (Capture)                                 â”‚ â”‚
â”‚  â”‚ - Format natif (peut varier)                               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                 â”‚                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ AudioCapture::ProcessMicrophoneAudio()                     â”‚ â”‚
â”‚  â”‚ 1. ConvertToFloat32()                                     â”‚ â”‚
â”‚  â”‚ 2. ResampleToTarget() â†’ 48kHz                             â”‚ â”‚
â”‚  â”‚ 3. AdaptChannels() â†’ StÃ©rÃ©o                               â”‚ â”‚
â”‚  â”‚ Output: float32, 48kHz, stÃ©rÃ©o                             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                 â”‚                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Callback JavaScript                                        â”‚ â”‚
â”‚  â”‚ â†’ FeedAudioData(buffer, numFrames, source)                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AudioEngine (Clock Master - OBS-like)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ FeedAudioData()                                            â”‚ â”‚
â”‚  â”‚ â†’ Ajoute Ã  m_desktopBuffer ou m_micBuffer                 â”‚ â”‚
â”‚  â”‚ â†’ Thread-safe (mutex)                                     â”‚ â”‚
â”‚  â”‚ â†’ Buffer: vector<float> (interleaved stereo)              â”‚ â”‚
â”‚  â”‚   [L0, R0, L1, R1, L2, R2, ...]                           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                 â”‚                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Tick() (appelÃ© toutes les 10ms depuis JS)                 â”‚ â”‚
â”‚  â”‚ 1. GetMonotonicTimeMs()                                    â”‚ â”‚
â”‚  â”‚    â†’ QueryPerformanceCounter (monotonic clock)            â”‚ â”‚
â”‚  â”‚ 2. Calcul expectedFrames                                   â”‚ â”‚
â”‚  â”‚    â†’ expectedFrames = (elapsedMs * 48000) / 1000           â”‚ â”‚
â”‚  â”‚ 3. Calcul framesToSend                                    â”‚ â”‚
â”‚  â”‚    â†’ framesToSend = expectedFrames - m_framesSent          â”‚ â”‚
â”‚  â”‚ 4. Clamp Ã  maxFramesPerTick (4800 = 100ms)                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                 â”‚                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ MixAudio(numFrames, output)                                â”‚ â”‚
â”‚  â”‚ â†’ OBS-like: non-blocking mixing                           â”‚ â”‚
â”‚  â”‚ â†’ Si desktop manquant: silence (0.0)                      â”‚ â”‚
â”‚  â”‚ â†’ Si mic manquant: silence (0.0)                          â”‚ â”‚
â”‚  â”‚ â†’ Mix: desktopSample + micSample * gain                    â”‚ â”‚
â”‚  â”‚ â†’ Clamp: [-1.0, 1.0]                                      â”‚ â”‚
â”‚  â”‚ â†’ Retire frames consommÃ©es des buffers                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                 â”‚                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ AudioPacketManager::CreatePacket()                        â”‚ â”‚
â”‚  â”‚ â†’ Convertit float32 â†’ uint8_t (memcpy)                       â”‚ â”‚
â”‚  â”‚ â†’ CrÃ©e AudioPacket avec PTS explicite                      â”‚ â”‚
â”‚  â”‚   - pts = m_framesSent (en frames)                        â”‚ â”‚
â”‚  â”‚   - dts = pts (audio, pas de B-frames)                    â”‚ â”‚
â”‚  â”‚   - duration = numFrames                                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                 â”‚                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Callback JavaScript (AudioPacket)                         â”‚ â”‚
â”‚  â”‚ â†’ ReÃ§oit AudioPacket avec PCM float32 + PTS               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AudioEncoder (libavcodec - AAC)                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ EncodeFrames(pcmData, numFrames, ptsFrames)              â”‚ â”‚
â”‚  â”‚ 1. Convertit interleaved â†’ planar float32                â”‚ â”‚
â”‚  â”‚    â†’ leftChannel = pcmData[0, 2, 4, ...]                 â”‚ â”‚
â”‚  â”‚    â†’ rightChannel = pcmData[1, 3, 5, ...]                 â”‚ â”‚
â”‚  â”‚ 2. Remplit frame avec silence si nÃ©cessaire               â”‚ â”‚
â”‚  â”‚    â†’ frame->pts = ptsFrames + framesProcessed             â”‚ â”‚
â”‚  â”‚ 3. avcodec_send_frame()                                   â”‚ â”‚
â”‚  â”‚ 4. avcodec_receive_packet() (boucle)                      â”‚ â”‚
â”‚  â”‚    â†’ CrÃ©e AudioPacket avec donnÃ©es AAC encodÃ©es           â”‚ â”‚
â”‚  â”‚    â†’ PTS/DTS depuis encoder                               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                 â”‚                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Return: vector<AudioPacket> (AAC encoded)                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AudioMuxer (libavformat - MP4)                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ WritePacket(AudioPacket)                                   â”‚ â”‚
â”‚  â”‚ 1. CrÃ©e AVPacket* (FFmpeg)                                â”‚ â”‚
â”‚  â”‚ 2. Copie donnÃ©es AAC                                      â”‚ â”‚
â”‚  â”‚ 3. Set PTS/DTS/duration                                   â”‚ â”‚
â”‚  â”‚ 4. av_packet_rescale_ts()                                 â”‚ â”‚
â”‚  â”‚    â†’ Rescale codec time_base â†’ stream time_base           â”‚ â”‚
â”‚  â”‚ 5. av_interleaved_write_frame()                           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                 â”‚                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Output: MP4 file avec audio AAC                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Points critiques pour les artefacts

### 1. **WASAPI Capture â†’ AudioCapture Processing**
```
ProblÃ¨mes potentiels:
- âŒ Resampling incorrect (aliasing, artefacts)
- âŒ Conversion int16 â†’ float32 (overflow, clipping)
- âŒ Adaptation channels (mono â†’ stereo mal fait)
- âŒ Buffer underrun/overrun
```

### 2. **AudioEngine Buffering**
```
ProblÃ¨mes potentiels:
- âŒ Race condition (mutex pas assez protecteur)
- âŒ Buffer overflow (trop de donnÃ©es accumulÃ©es)
- âŒ Buffer underrun (pas assez de donnÃ©es)
- âŒ Frames mal alignÃ©es (dÃ©calage temporel)
```

### 3. **AudioEngine Mixing**
```
ProblÃ¨mes potentiels:
- âŒ Clipping (mix > 1.0 non clampÃ© correctement)
- âŒ Gain incorrect (micGain = 0.9 peut causer dÃ©sÃ©quilibre)
- âŒ Synchronisation desktop/mic (dÃ©calage)
- âŒ Silence mal gÃ©rÃ© (zÃ©ro pas exact)
```

### 4. **AudioEngine Clock Master**
```
ProblÃ¨mes potentiels:
- âŒ Drift temporel (expectedFrames vs framesSent)
- âŒ Tick rate irrÃ©gulier (10ms pas constant)
- âŒ PTS incorrect (m_framesSent mal calculÃ©)
- âŒ Frames sautÃ©es ou dupliquÃ©es
```

### 5. **AudioEncoder (libavcodec)**
```
ProblÃ¨mes potentiels:
- âŒ Conversion interleaved â†’ planar incorrecte
- âŒ Frame size mismatch (encoder attend 1024 frames)
- âŒ PTS mal assignÃ© (frame->pts incorrect)
- âŒ Silence padding incorrect
- âŒ Buffer overflow dans encoder
```

### 6. **AudioMuxer (libavformat)**
```
ProblÃ¨mes potentiels:
- âŒ PTS rescaling incorrect (time_base mismatch)
- âŒ Packets dans le mauvais ordre
- âŒ DTS/PTS incohÃ©rents
- âŒ Stream time_base incorrect
```

## Zones Ã  vÃ©rifier en prioritÃ©

### ğŸ”´ Zone 1: AudioEngine Mixing
```cpp
// audio_engine.cpp:111 - MixAudio()
// VÃ©rifier:
- Clamping correct [-1.0, 1.0]
- Gain mic correct
- Synchronisation desktop/mic
- Pas de NaN ou Inf
```

### ğŸ”´ Zone 2: AudioEngine Clock/Timing
```cpp
// audio_engine.cpp:164 - Tick()
// VÃ©rifier:
- expectedFrames calcul correct
- framesToSend pas nÃ©gatif
- m_framesSent mis Ã  jour correctement
- Pas de saut de frames
```

### ğŸ”´ Zone 3: AudioEncoder Frame Processing
```cpp
// audio_encoder.cpp:117 - EncodeFrames()
// VÃ©rifier:
- Conversion interleaved â†’ planar correcte
- Frame size matching (1024 frames pour AAC)
- PTS assignment correct
- Pas de corruption de donnÃ©es
```

### ğŸ”´ Zone 4: Buffer Management
```cpp
// audio_engine.cpp:87 - FeedAudioData()
// audio_engine.cpp:149 - MixAudio() (buffer removal)
// VÃ©rifier:
- Pas de buffer overflow
- Pas de buffer underrun
- Frames correctement retirÃ©es
- Pas de fuite mÃ©moire
```

## Debug recommandations

1. **Ajouter des logs** dans chaque Ã©tape pour voir oÃ¹ les artefacts apparaissent
2. **VÃ©rifier les valeurs** (NaN, Inf, clipping)
3. **VÃ©rifier la synchronisation** desktop/mic
4. **VÃ©rifier le PTS** Ã  chaque Ã©tape
5. **VÃ©rifier les tailles de buffers** et frame counts




